# Безопасность загрузки файлов

## Реализованные меры безопасности

### 1. Проверка MIME-типа и реального формата
- ✅ Проверка MIME-типа на уровне multer
- ✅ Проверка реального формата через Sharp (библиотека для обработки изображений)
- ✅ Запрет файлов, которые не проходят обе проверки

### 2. Пересохранение изображений
- ✅ Все изображения перекодируются в JPEG через Sharp
- ✅ Это полностью уничтожает любой вредоносный код внутри файла
- ✅ Изображения автоматически обрезаются до 512x512px

### 3. Безопасное хранение
- ✅ Изображения хранятся в отдельной директории `/uploads/avatars/`
- ✅ Используются безопасные заголовки HTTP (X-Content-Type-Options: nosniff)
- ✅ Nginx конфигурация запрещает выполнение скриптов в директории uploads

### 4. Случайные имена файлов
- ✅ Используется UUID v4 для генерации имен файлов
- ✅ Оригинальное имя файла не используется
- ✅ Все файлы сохраняются с расширением `.jpg`

### 5. Проверка размера
- ✅ Максимальный размер файла: 5MB
- ✅ Максимальный размер изображения: 6000x6000px
- ✅ Автоматическое масштабирование до 512x512px

### 6. Запрет опасных форматов
- ✅ Разрешены только JPEG и PNG
- ✅ SVG, ICO, WEBP, GIF запрещены
- ✅ Все файлы пересохраняются в JPEG

### 7. Корректные ошибки
- ✅ Все проверки возвращают понятные сообщения об ошибках на русском языке
- ✅ Логирование всех операций для отладки

## Установка зависимостей

```bash
cd server
npm install
```

Это установит:
- `sharp` - для обработки и валидации изображений
- `uuid` - для генерации безопасных имен файлов

## Настройка Nginx

1. Скопируйте `nginx.conf.example` в конфигурацию вашего сайта:
```bash
sudo cp server/nginx.conf.example /etc/nginx/sites-available/your-site
```

2. Отредактируйте пути:
   - Замените `/path/to/your/project` на реальный путь к проекту
   - Настройте домен в `server_name`

3. Проверьте конфигурацию:
```bash
sudo nginx -t
```

4. Перезагрузите Nginx:
```bash
sudo systemctl reload nginx
```

## API Endpoints

### POST /api/me/avatar
Загрузка нового аватара.

**Требования:**
- Аутентификация (Bearer token)
- Content-Type: multipart/form-data
- Поле: `avatar` (File)
- Формат: JPEG или PNG
- Максимальный размер: 5MB

**Ответ:**
```json
{
  "success": true,
  "avatarUrl": "/uploads/avatars/uuid.jpg"
}
```

**Ошибки:**
- `400` - Неверный формат файла или превышен размер
- `401` - Не авторизован
- `500` - Ошибка сервера

### DELETE /api/me/avatar
Удаление текущего аватара.

**Требования:**
- Аутентификация (Bearer token)

**Ответ:**
```json
{
  "success": true,
  "avatarUrl": null
}
```

## Структура директорий

```
server/
├── uploads/
│   ├── avatars/          # Аватары пользователей (UUID.jpg)
│   └── ...               # Другие загруженные файлы
└── ...
```

## Безопасность на уровне файловой системы

Рекомендуется установить правильные права доступа:

```bash
# Только чтение для веб-сервера
chmod 755 server/uploads/avatars
chmod 644 server/uploads/avatars/*.jpg

# Владелец - пользователь веб-сервера (обычно www-data или nginx)
chown -R www-data:www-data server/uploads/avatars
```

## Мониторинг

Все операции логируются в консоль сервера:
- Загрузка файлов
- Ошибки валидации
- Удаление старых аватаров
- Ошибки обработки изображений

## Миграция со старой системы

Старые аватары, сохраненные как base64 в базе данных, будут работать до тех пор, пока пользователь не загрузит новый аватар. Новые аватары всегда сохраняются как файлы.

Для миграции старых аватаров можно создать скрипт, который:
1. Извлекает base64 из базы данных
2. Конвертирует в файл
3. Обрабатывает через `processAvatarImage`
4. Обновляет URL в базе данных

