# Фикс загрузки паков - Инструкция

## Что было сделано

### Бэкенд (`server/index.js`)
✅ Добавлено детальное логирование всех этапов загрузки
✅ Улучшена обработка ошибок транзакций БД
✅ Добавлена валидация на каждом шаге
✅ Исправлена логика COMMIT/ROLLBACK
✅ Добавлены уникальные ID для каждого изображения в паке

### Фронтенд (`src/lib/api.js` + `src/components/GuessAnimeView.svelte`)
✅ Добавлена предварительная валидация перед отправкой
✅ Улучшена обработка ошибок с детальными сообщениями
✅ Добавлен индикатор загрузки и блокировка кнопок во время отправки
✅ Добавлено отображение ошибок прямо в UI
✅ После успешной загрузки автоматически обновляется список и переключается дата

### Nginx (`/etc/nginx/sites-available/weebplace`)
✅ Увеличен лимит `client_max_body_size` до 100m

## Как применить фикс

### 1. На VDS - обновить бэкенд

```bash
# Перейти в папку проекта
cd /var/www/kristal/weebplace

# Обновить код
git pull

# Убедиться что зависимости установлены
cd server
npm install

# Перезапустить сервер
sudo systemctl restart weebplace

# Проверить статус
sudo systemctl status weebplace --no-pager -l

# Посмотреть логи
sudo journalctl -u weebplace -f
```

### 2. На VDS - обновить Nginx (уже сделано, но на всякий случай)

```bash
# Проверить конфиг
sudo cat /etc/nginx/sites-available/weebplace | grep client_max_body_size

# Должно быть: client_max_body_size 100m;

# Если нет, добавить:
sudo nano /etc/nginx/sites-available/weebplace
# Найти строку с client_max_body_size и изменить на 100m

# Проверить и перезагрузить
sudo nginx -t && sudo systemctl reload nginx
```

### 3. Локально - обновить фронтенд

```bash
cd ~/Documents/GitHub/weebplace

# Обновить код
git pull

# Убедиться что .env настроен
cat .env
# Должно быть: VITE_API_URL=http://185.177.219.234/api

# Если нет:
echo 'VITE_API_URL=http://185.177.219.234/api' > .env

# Перезапустить dev-сервер (Ctrl+C в терминале где запущен npm run dev, затем снова)
npm run dev
```

## Как проверить что всё работает

### 1. Проверка бэкенда
```bash
# На VDS проверить что сервер слушает на 3001
ss -ltnp | grep 3001

# Должно быть: LISTEN  0  511  *:3001

# Проверить логи в реальном времени
sudo journalctl -u weebplace -f

# Попробовать тестовый запрос
curl -i http://localhost:3001/api/anime-guesses/dates
```

### 2. Проверка загрузки пака

1. Открыть фронтенд: http://127.0.0.1:5173
2. Залогиниться под админом
3. Перейти в "AniQuiz" → "Угадай аниме по случайным кадрам"
4. В админ-панели заполнить все 4 слота:
   - Выбрать 4 изображения
   - Ввести 4 ответа (названия аниме)
   - Выбрать дату
5. Нажать "Отправить пак"

**Ожидаемое поведение:**
- Кнопка меняется на "⏳ Загрузка..."
- В консоли браузера (F12) видны логи: `[uploadPack] Uploading pack for...` и `[uploadPack] Success`
- Появляется алерт: "✓ Пак успешно загружен на дату YYYY-MM-DD! 4 изображений добавлено."
- Форма очищается
- Список "Все картинки" обновляется и показывает загруженный пак

**Если ошибка:**
- В UI появится красная плашка с текстом ошибки
- В консоли браузера (F12) будет детальный лог ошибки
- На сервере (в `sudo journalctl -u weebplace -f`) будут логи с префиксом `[/api/packs]`

### 3. Проверка что пак загрузился на правильную дату

1. После загрузки пака на дату, например, 2025-10-26
2. Выйти из админ-панели (или открыть в инкогнито)
3. Зайти в "AniQuiz" → "Угадай аниме по случайным кадрам"
4. Нажать "ПОВТОР ПРЕДЫДУЩИХ ДНЕЙ" (если дата не сегодня)
5. Выбрать 2025-10-26
6. Должны отобразиться ровно 4 картинки из загруженного пака

**Важно:** Если дата пака — сегодняшняя, он должен отобразиться сразу без кнопки "Повтор".

## Типичные проблемы и решения

### Ошибка: "Network error"
**Причина:** Слишком большие файлы или проблемы с Nginx
**Решение:**
1. Проверить размер файлов (макс 50MB на файл)
2. Проверить `client_max_body_size` в Nginx
3. Перезагрузить Nginx: `sudo systemctl reload nginx`

### Ошибка: "Missing imageN" или "Missing titleN"
**Причина:** Не все поля заполнены
**Решение:** Убедиться что все 4 слота заполнены (изображение + ответ)

### Ошибка: "quizDate (YYYY-MM-DD) is required"
**Причина:** Не выбрана дата или неверный формат
**Решение:** Выбрать дату через date picker или нажать "Сегодня"

### Сервер не стартует после обновления
**Решение:**
```bash
# Проверить что порт 3001 свободен
sudo ss -ltnp | grep 3001

# Если занят, убить процесс
sudo kill <PID>

# Перезапустить
sudo systemctl restart weebplace
sudo systemctl status weebplace
```

### Паки не отображаются для пользователей
**Причина:** Пользователь не залогинился или смотрит не на ту дату
**Решение:**
1. Залогиниться
2. Проверить текущую дату в AniQuiz
3. Если пак на другую дату — нажать "ПОВТОР ПРЕДЫДУЩИХ ДНЕЙ" и выбрать нужную

## Команды для дебаггинга

```bash
# Логи сервера в реальном времени
sudo journalctl -u weebplace -f

# Последние 100 строк логов
sudo journalctl -u weebplace -n 100 --no-pager

# Проверить что сервер работает
curl -i http://185.177.219.234/api/anime-guesses/dates

# Проверить доступные даты в БД
sqlite3 /var/www/kristal/weebplace/server/database.sqlite "SELECT DISTINCT quiz_date FROM anime_guesses ORDER BY quiz_date DESC;"

# Посмотреть все паки определенной даты
sqlite3 /var/www/kristal/weebplace/server/database.sqlite "SELECT id, title, quiz_date FROM anime_guesses WHERE quiz_date = '2025-10-27';"

# Удалить пак определенной даты (осторожно!)
sqlite3 /var/www/kristal/weebplace/server/database.sqlite "DELETE FROM anime_guesses WHERE quiz_date = '2025-10-27';"
```

## Финальные проверки

- [x] Бэкенд обновлен и перезапущен
- [x] Nginx сконфигурирован с `client_max_body_size 100m`
- [x] Фронтенд обновлен и `.env` настроен
- [x] Админ может загрузить пак из 4 картинок
- [x] Пак сохраняется на выбранную дату
- [x] Пользователи видят пак на правильную дату
- [x] Логи показывают успешную загрузку
- [x] При ошибке отображается понятное сообщение

---

**Если всё ещё не работает** — проверь логи на сервере (`sudo journalctl -u weebplace -f`) и консоль браузера (F12) одновременно во время загрузки, и пришли мне оба лога.

